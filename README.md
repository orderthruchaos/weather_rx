# WeatherRx README

## Docker Compose and GNU Make

This application was written to leverage Docker for system containerization.  A
GNU Makefile was added to ease certain common development activities.

Before doing anything, make sure the following environment variables are set
in your shell for container setup (see __Environment Variables__ below for
descriptions and defaults):

* `RAILS_ENV`
* `POSTGRES_USER`
* `POSTGRES_PASSWORD`
* `POSTGRES_DB`

These are for initial connection database creation, not application database
setup.  Once these variables are set, you can either use `docker compose build`
or `make build` to build the docker images.

At this point, you should create `.env.local`, `.env.development.local`, and
`.env.test.local` files to add overrides for the remaining environment
variables listed below.

Next, to start the services, you can use `make up`, which does `docker compose up`,
or `make upd` to add the `-d` flag for the `up` subcommand.

You can use `make dbsetup` to initialize the databases for the system.

The application is accessed via: http://localhost:3000

The test suite can be run via `make test`.

## Environment Variables

| Name                       | Description                                           | Default                |
| ------------------------   | ----------------------------------------------------- | ---------------------- |
| `RAILS_ENV`                | Rails environment                                     | `development`          |
| `POSTGRES_USER`            | Database user to be used for migrations               | `$USER`                |
| `POSTGRES_PASSWORD`        | Password for application database user                | `$USER`                |
| `POSTGRES_DB`              | Initial database created for connection to the server | `$USER`                |
| `WEATHER_RX_DB_HOST`       | Application database host name                        | `postgres`             |
| `WEATHER_RX_DB_PORT`       | Application database port number                      | `5432`                 |
| `WEATHER_RX_DB_PSWD`       | Application database password                         | _N/A_                  |
| `WEATHER_RX_DB_USER`       | Application database username                         | `$USER`                |
| `WEATHER_RX_REDIS_PW`      | Application Redis server password                     | _N/A_                  |
| `NWS_API_USER_AGENT_HOST`  | Host for NWS API authentication                       | `example.com`          |
| `NWS_API_USER_AGENT_EMAIL` | Email address for NWS API authentication              | `no-reply@example.com` |
| `REDIS_URL`                | URL for Redis cache server                            | `redis://redis:6379`   |

## External APIs

### National Weather Service

Documentation:  https://www.weather.gov/documentation/services-web-api

OpenAPI Specification (JSON-DL):  https://api.weather.gov/openapi.json

Necessary endpoints:

  - `https://api.weather.gov/points/{lat},{lon}`
    - `station = response["properties"]["gridId"]`
    - `grid_x = response["properties"]["gridX"]`
    - `grid_y = response["properties"]["gridY"]`
  - `https://api.weather.gov/gridpoints/{station}/{gridX},{gridY}/forecast`
  - `https://api.weather.gov/gridpoints/{station}/{gridX},{gridY}/forecast/hourly`

Authentication is done via User-Agent, with should have the following format:

```
User-Agent: (myweatherapp.com, contact@myweatherapp.com)
```

Results are returned as GeoJSON:

```
Accept: application/geo+json
```

### US Census Geocodeing Service

The US Census Geocoding Services API will be used to get the latitude and
longitude of an address.

Documentation:  https://geocoding.geo.census.gov/geocoder/Geocoding_Services_API.html

Example API call:  https://geocoding.geo.census.gov/geocoder/locations/address?street=4600+Silver+Hill+Rd&city=Washington&state=DC&benchmark=4&format=json

Note that `benchmark=4` means the current benchmark.  The cleaned up JSON
result is in `test/data/address_example.json`

### External Data Files

External data files are located in `db/data`.

[USPS zip code files](https://postalpro.usps.com/address-quality/ais-viewer):

  - [`db/data/AISUREPT_2.TXT`](https://postalpro.usps.com/storages/2025-04/AISUREPT_2.TXT)
  - [`db/data/AREA_DIST_ZIP_2.TXT`](https://postalpro.usps.com/storages/2025-04/AREA_DIST_ZIP_2.TXT)

The USA states and territories CSV file was generated by ChatGPT:

  - `db/data/us_states_and_territories.csv`
